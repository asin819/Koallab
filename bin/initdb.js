let base = require('./base');
let mongoose = require("mongoose");
let mongoHost = "127.0.0.1:27017";
let database = "khakikoalasdb";

let uri = "mongodb://" + mongoHost + "/" + database;

// mongoose.Promise = global.Promise;

/**
 * Initialize system basic data
 * 
 * userid generated by base.getObjectId()
 * groupid generated by base.getObjectId()
 * projectid generated by base.getObjectId()
 * resourceid generated by base.getObjectId()
 * taskid generated by base.getObjectId()
 * logid generated by base.getObjectId()
 */
let init = async function () {

    //user: userid, email, password, registrationtime, userstatus (normal, deleted)| username, photo (Base64 format), authorizationtoken, authorizationgenerationtime, authorizationvalidityexpirationdate
    let myUsers = [
        { "userid": "0001", "email": "syan408@aucklanduni.ac.nz", "password": "123", "userstatus": "normal", "username": "syan408", "photo": "", "authorizationtoken": "", },
    ];
    await global.db.modUser.insertMany(myUsers).then((docs) => {
        console.log("Initialize user list:" + docs.length);
    });

    //group: groupid, groupname, creatorid, creationtime, groupstatus (normal, disbanded)
    let myGroups = [
        { "groupid": "000001", "groupname": "Front-end Group", "creatorid": "0001", "groupstatus": "normal" },
        { "groupid": "000002", "groupname": "Back-end Group", "creatorid": "0001", "groupstatus": "normal" },
    ];
    await global.db.modGroup.insertMany(myGroups).then((docs) => {
        console.log("Initialize group list:" + docs.length);
    });

    //Group_User_Relationship: groupid, userid, role (administrator, member), jointime
    let myGroup_User_Relationships = [
        { "groupid": "000002", "userid": "0001", "role": "administrator" }
    ];
    await global.db.modGroup_User_Relationship.insertMany(myGroup_User_Relationships).then((docs) => {
        console.log("Initialize Group_User_Relationship list:" + docs.length);
    });

    //Project: projectid, projectname, creatorid, creationtime, projectstatus (normal, closed)|Startime, endtime
    let myProjects = [
        { "projectid": "00000001", "projectname": "Khaki Koalas", "creatorid": "0001", "projectstatus": "normal" }
    ];
    await global.db.modProject.insertMany(myProjects).then((docs) => {
        console.log("Initialize Project list:" + docs.length);
    });

    //Project_User_Relationship: projectid, userid, role (administrator, member), jointime
    let myProject_User_Relationships = [
        { "projectid": "00000001", "userid": "0001", "role": "administrator" }
    ];
    await global.db.modProject_User_Relationship.insertMany(myProject_User_Relationships).then((docs) => {
        console.log("Initialize Project_User_Relationship list:" + docs.length);
    });

    //Project_Resource_Table: resourceid, projectid, resourcetype (video, audio, image, file), path (relative path)
    let myProject_Resource_Tables = [
        { "resourceid": "0000000001", "projectid": "00000001", "resourcetype": "image", "path": "../public/images/syan408_head.png" }
    ];
    await global.db.modProject_Resource_Table.insertMany(myProject_Resource_Tables).then((docs) => {
        console.log("Initialize Project_Resource_Table list:" + docs.length);
    });

    //task: taskid, tasktitle, taskdescription, creatorid, executorid, taskstatus (new, executing, completed, accepted, obsolete), parentaskid | estimatedtime (how many hours), importance (Non-Important, Important, Average), tasklabel (array)
    let myTasks = [
        { "taskid": "0000000000000001", "tasktitle": "Back-end development task division", "taskdescription": "Tasks need to be divided up according to the interface documentation, making it clear which interfaces each person needs to complete for development.", "creatorid": "0001", "executorid": "0001", "taskstatus": "new", "parentaskid": "", "estimatedtime": 8, "importance": "Important", "tasklabel": ["Back-end", "development", "task division"] }
    ];
    await global.db.modTask.insertMany(myTasks).then((docs) => {
        console.log("Initialize myTasks list:" + docs.length);
    });

    //Task_Log: logid, taskid, content, addtime, adderid
    let myTask_Logs = [
        { "logid": "00000000000000000001", "taskid": "0000000000000001", "content": "Create new task", "adderid": "0001" }
    ];
    await global.db.modTask_Log.insertMany(myTask_Logs).then((docs) => {
        console.log("Initialize Task_Log list:" + docs.length);
    });

    //Project_Task_Relationship: projectid, taskid, addtime, adderid
    let myProject_Task_Relationships = [
        { "projectid": "00000001", "taskid": "0000000000000001", "adderid": "0001" }
    ];
    await global.db.modProject_Task_Relationship.insertMany(myProject_Task_Relationships).then((docs) => {
        console.log("Initialize Project_Task_Relationship list:" + docs.length);
    });
};

let createdb = async function(){
    await mongoose.connect(uri, {
        useNewUrlParser: true,
        // useFindAndModify: false,
        useUnifiedTopology: true
        // useMongoClient: true
        /*,
        user: "",
        pass: ""*/
    }).then(async (db) => {
        global.db = db;
    
        require("./initmodel");
    
        await  global.db.modUser.find({}).then(async (docs) => {
            if (docs.length > 0) {
                console.log("database already initialized!");
            } else {
                console.log("start initializing database...");
                await init();
                console.log("initialize database done!")
            }
        })
    }).catch((e) => {
        console.log(e);
    });
}

createdb();
